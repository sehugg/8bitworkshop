import{a as gt}from"./chunk-MEEQZYRD.js";import{A as xt,H as ut,g as ot,k as ct,p as lt,s as ft,x as dt}from"./chunk-SOYNARJ7.js";import{$ as M,J as T,U as E,V as i,W as at,Y as nt,a as C,da as ht,g as f,r as _}from"./chunk-QWAF5HSH.js";import"./chunk-KT7KMEQC.js";var Ut=[0,25,17,9],Yt=[0,89,97,105],S=0,Bt=1,G=2,W=3,Ht=4,Qt=5,jt=7,zt=9,N=10,Xt=11,qt=12,Gt=13,mt=14,Wt=15,F=15;var Zt=13,$t=106,Jt=105,Z=[0,0,8,10,8,16,8,16,8,4,4,2,1,2,1,1],te=[0,0,2,2,2,2,4,4,8,4,4,4,4,2,2,2],ee=[0,0,0,0,0,1,0,1,0,0,2,1,0,0,0,0],pt=[0,0,1,1,2,2,2,2,8,4,4,2,2,2,2,1],k=class{constructor(e,t){this.regs=new Uint8Array(16);this.dma_enabled=!1;this.dliop=0;this.mode=0;this.jmp=!1;this.lms=!1;this.dlarg_lo=0;this.dlarg_hi=0;this.period=0;this.scanaddr=0;this.startaddr=0;this.pfbyte=0;this.ch=0;this.linesleft=0;this.yofs=0;this.isfirstline=!1;this.v=0;this.h=0;this.linebuf=new Uint8Array(48);this.dmaclock=0;this.dmaidx=0;this.output=0;this.dramrefresh=!1;this.in_vscroll=0;this.read=e,this.nmi=t}reset(){this.regs.fill(0),this.regs[mt]=0,this.regs[F]=127,this.regs[qt]=0,this.regs[Gt]=255,this.setReg(S,0),this.h=this.v=0,this.startaddr=this.scanaddr=0,this.dmaclock=0}saveState(){return _(0,{},this)}loadState(e){_(0,this,e),this.setReg(S,e.regs[S])}static stateToLongString(e){let t="";return t+="H: "+C(e.h,3)+"  V: "+C(e.v,3)+`
`,t+="DLIOp: "+f(e.dliop,2)+"  Lines: "+e.yofs+"/"+e.linesleft,t+="   DMA "+(e.dma_enabled?"ON ":"off"),e.dma_enabled&&(t+=" idx "+e.dmaidx+" clk "+f(e.dmaclock)),t+=`
`,t+="Addr: "+f(e.scanaddr,4)+`
`,t+=E(e.regs,0,16).replace("$00","Regs"),t}setReg(e,t){switch(e){case N:this.regs[N]=255;return;case Wt:this.regs[F]=31;return}this.regs[e]=t}readReg(e){switch(e){case F:return this.regs[e];case Xt:return this.v>>1;default:return 255}}processDLIEntry(){if(this.mode==0)this.linesleft=(this.dliop>>4&7)+1,this.dmaclock=0;else{this.linesleft=Z[this.mode],this.period=te[this.mode],this.jmp?(this.regs[G]=this.dlarg_lo,this.regs[W]=this.dlarg_hi,this.mode=this.period=0,this.dliop&64&&(this.linesleft=1,this.dma_enabled=!1),this.dmaclock=0):this.lms&&(this.scanaddr=this.dlarg_lo+(this.dlarg_hi<<8)),this.startaddr=this.scanaddr;let e=this.regs[S]&3,t=this.dliop&16?(this.regs[Ht]&15)>>1:0;this.dliop&16&&e<3&&e++,this.left=Ut[e]+t,this.right=Yt[e]+t;let s=this.regs[Qt]&15;this.dliop&32^this.in_vscroll&&(this.in_vscroll?this.linesleft=s+1:(this.linesleft-=s,this.yofs+=s),this.linesleft&=15,this.in_vscroll^=32)}}nextLine(){this.linesleft>0&&(this.linesleft--,this.yofs++,this.isfirstline=!1,this.mode>=8&&this.linesleft&&(this.scanaddr=this.startaddr))}triggerNMI(e){this.regs[F]=e|31,this.regs[mt]&e&&this.nmi()}getDlistAddr(){return this.regs[G]+(this.regs[W]<<8)}nextInsn(){let e=this.getDlistAddr(),t=this.read(e);return e=e+1&1023|e&-1024,this.regs[G]=e&255,this.regs[W]=e>>8,t}nextScreen(){let e=this.read(this.scanaddr);return this.incScanAddr(),e}incScanAddr(){this.scanaddr=this.scanaddr+1&4095|this.scanaddr&-4096}dlDMAEnabled(){return this.regs[S]&32}isVisibleScanline(){return this.v>=8&&this.v<248}isPlayfieldDMAEnabled(){return this.dma_enabled&&!this.linesleft}isPlayerDMAEnabled(){return this.regs[S]&8}isMissileDMAEnabled(){return this.regs[S]&12}isWSYNC(){return this.regs[N]!=0}clockPulse(){let e=this.isWSYNC();if(!this.isVisibleScanline())this.doVBlank();else{switch(this.h){case 0:this.isMissileDMAEnabled()&&(this.doPlayerMissileDMA(3),e=!0);break;case 1:if(this.isPlayfieldDMAEnabled()){let t=this.nextInsn();this.jmp=(t&-65)==1,this.lms=(t&64)!=0&&(t&15)!=0,this.mode=t&15,this.dliop=t,this.yofs=0,this.isfirstline=!0,e=!0}break;case 2:case 3:case 4:case 5:this.isPlayerDMAEnabled()&&(this.doPlayerMissileDMA(this.h+2),e=!0);break;case 6:case 7:this.isPlayfieldDMAEnabled()&&this.isfirstline&&(this.jmp||this.lms)&&(this.h==6&&(this.dlarg_lo=this.nextInsn()),this.h==7&&(this.dlarg_hi=this.nextInsn()),e=!0);break;case 8:this.isfirstline&&this.processDLIEntry(),this.dliop&128&&this.linesleft==1&&this.triggerNMI(128);break;case 9:break;case 111:this.dma_enabled&&this.nextLine(),++this.v;break}if(this.output=0,this.mode>=2&&this.period){let t=this.h<=Jt;this.dmaclock=this.dmaclock<<1&511,this.dmaclock&1<<this.period&&(this.dmaclock|=1),this.h==this.left&&(this.dmaclock|=1,this.dmaidx=0),this.h==this.right&&(this.dmaclock&=-2,this.dmaidx++),this.dmaclock&1?(this.mode<8&&this.isfirstline&&(t?this.linebuf[this.dmaidx]=this.nextScreen():this.incScanAddr(),e=t),this.dmaidx++):this.dmaclock&8&&(this.ch=this.linebuf[this.dmaidx-4/this.period],t?this.readBitmapData():this.mode>=8&&this.incScanAddr(),e=t),this.output=this.h>=this.left+3&&this.h<=this.right+2?4:0}}return(this.h<Zt||this.h>$t)&&(this.output=2),this.incHorizCounter(),!e&&this.dramrefresh&&(this.read(0),this.dramrefresh=!1,e=!0),e}incHorizCounter(){switch(this.h){case 25:case 29:case 33:case 37:case 41:case 45:case 49:case 53:case 57:this.dramrefresh=!0;break;case 102:this.regs[N]=0;break;case 113:this.h=0;return}++this.h}doVBlank(){this.linesleft=this.mode=this.period=0,this.h==111&&this.v++,this.v==248&&this.h==0&&this.triggerNMI(64),this.v==262&&this.h==112&&(this.v=0),this.v==7&&this.h==113&&(this.dma_enabled=this.dlDMAEnabled()!=0),this.output=2,this.dmaclock=0}doPlayerMissileDMA(e){let t=this.regs[S]&16,s=this.regs[jt]<<8;t?(s&=63488,s|=e<<8,s|=this.v&255):(s&=64512,s|=e<<7,s|=this.v>>1),this.read(s)}readBitmapData(){let e=this.mode;if(e<8){let t=this.ch,s=this.yofs>>ee[this.mode],n=s&7,a=this.regs[zt];(e&14)==6?(t&=63,a&=254):(t&=127,a&=252);let h=(t<<3)+(a<<8);if((e&14)==2){let l=this.regs[Bt],o=e==3&&(t&96)==96;l&4?this.pfbyte=this.read(h+(n^7)):this.pfbyte=this.read(h+n),o&&s<2&&(this.pfbyte=0),!o&&s>7&&(this.pfbyte=0),this.ch&128&&(l&1&&(this.pfbyte=0),l&2&&(this.pfbyte^=255))}else this.pfbyte=this.read(h+n)}else this.pfbyte=this.nextScreen()}shiftout(){if(this.output==4)switch(this.mode){case 2:case 3:case 15:{let e=this.pfbyte>>7&1;return this.pfbyte<<=1,e?8:6}case 6:case 7:{let e=this.pfbyte>>7&1;return this.pfbyte<<=1,e?(this.ch>>6)+4:0}case 9:case 11:case 12:{let e=this.pfbyte>>7&1;return this.pfbyte<<=1,e?4:0}case 4:case 5:{let e=this.pfbyte>>6&3;return this.pfbyte<<=2,this.ch&128?[0,4,5,7][e]:[0,4,5,6][e]}case 8:case 10:case 13:case 14:{let e=this.pfbyte>>6&3;return this.pfbyte<<=2,[0,4,5,6][e]}}return this.output}};var se=0;var ie=8,re=12,bt=13,_t=17,y=18,m=22,ae=23,ne=24,he=25,O=26,U=27,oe=28,yt=29,ce=30,le=31,fe=0,de=4,xe=8,Y=12,St=16,$=31,At=-9,B=[0,1,2,3,7,7,7,7,8,8,8,8,4,5,6,7,0,1,2,3,7,7,7,7,8,8,8,8,4,5,6,7,0,1,6,7,5,5,5,5,8,8,8,8,2,3,4,5,0,1,6,7,5,5,5,5,8,8,8,8,2,3,4,5,4,5,6,7,3,3,3,3,8,8,8,8,0,1,2,3,4,5,6,7,3,3,3,3,8,8,8,8,0,1,2,3,4,5,6,7,3,3,3,3,8,8,8,8,0,1,2,3,4,5,6,7,3,3,3,3,8,8,8,8,0,1,2,3,2,3,4,5,7,7,7,7,8,8,8,8,0,1,6,7,2,3,4,5,7,7,7,7,8,8,8,8,0,1,6,7,2,3,4,5,7,7,7,7,8,8,8,8,0,1,6,7,2,3,4,5,7,7,7,7,8,8,8,8,0,1,6,7,2,3,4,5,7,7,7,7,8,8,8,8,0,1,6,7,2,3,4,5,7,7,7,7,8,8,8,8,0,1,6,7,2,3,4,5,7,7,7,7,8,8,8,8,0,1,6,7,2,3,4,5,7,7,7,7,8,8,8,8,0,1,6,7],ue=[y+0,y+1,y+2,y+3,m+0,m+1,m+2,m+3,O,O,O,O,m+0,m+1,m+2,m+3],K=class{constructor(){this.regs=new Uint8Array(32);this.readregs=new Uint8Array(32);this.shiftregs=new Uint32Array(8);this.count=0;this.an=0;this.rgb=0;this.pmcol=0;this.gtiacol=0;this.gtiacol2=0;this.hbias=At;this.pmDebugMask=-1}reset(){this.regs.fill(0),this.readregs.fill(0),this.readregs[20]=15,this.readregs.fill(15,21),this.count=0}saveState(){return _(0,{},this)}loadState(e){_(0,this,e)}setReg(e,t){switch(e){case y:case y+1:case y+2:case y+3:case m:case m+1:case m+2:case m+3:case O:t&=254;break;case ce:this.readregs.fill(0,0,16);return}this.regs[e]=t}readReg(e){switch(e){case $:return this.readregs[e]&~this.regs[le]}return this.readregs[e]}sync(){this.count=0}setBias(e){this.hbias=At+e}updateGfx(e,t,s){switch(e){case 0:this.regs[yt]&1&&(this.regs[_t]=s);break;case 2:case 3:case 4:case 5:this.regs[yt]&2&&(!(t&1)||!(this.regs[oe]&1<<e+2))&&(this.regs[bt-2+e]=s);break}}getPlayfieldColor(){switch(this.regs[U]>>6){case 0:switch(this.an){case 0:return O;case 4:case 5:case 6:case 7:return m+this.an-4;case 8:return this.regs[ne]&240|this.regs[ae]&15|256}break;case 1:return this.regs[O]&240|this.gtiacol&15|256;case 2:return ue[this.gtiacol];case 3:return this.regs[O]&15|this.gtiacol<<4|256}return 256}anySpriteActive(){return this.shiftregs[0]||this.shiftregs[1]||this.shiftregs[2]||this.shiftregs[3]||this.shiftregs[4]||this.shiftregs[5]||this.shiftregs[6]||this.shiftregs[7]}processPlayerMissile(){if(!this.anySpriteActive()){this.evalTrigger(0),this.evalTrigger(1),this.evalTrigger(2),this.evalTrigger(3),this.evalTrigger(4),this.evalTrigger(5),this.evalTrigger(6),this.evalTrigger(7),this.pmcol=-1;return}if(this.an==2){this.shiftObject(0),this.shiftObject(1),this.shiftObject(2),this.shiftObject(3),this.shiftObject(4),this.shiftObject(5),this.shiftObject(6),this.shiftObject(7),this.pmcol=-1;return}let e=(this.regs[U]&15)<<4,t=B[(this.an&7)+8+e],s=this.an-4,n=-1,a=0;for(let h=0;h<4;h++)if(this.shiftObject(h)){s>=0&&(this.readregs[de+h]|=1<<s),a|=1<<h;let o=B[h+e];o<t&&(n=h,t=o)}for(let h=0;h<4;h++)if(this.shiftObject(h+4)){s>=0&&(this.readregs[fe+h]|=1<<s),this.readregs[xe+h]|=a;let o=this.regs[U]&16?B[e+15]:B[h+e];o<t&&(n=h+4,t=o)}a&1&&(this.readregs[Y+0]|=a&-2),a&2&&(this.readregs[Y+1]|=a&-3),a&4&&(this.readregs[Y+2]|=a&-5),a&8&&(this.readregs[Y+3]|=a&-9),this.pmcol=n>=0?this.getObjectColor(n):-1}shiftObject(e){let t=(this.shiftregs[e]&2147483648)!=0;return this.shiftregs[e]<<=1,this.evalTrigger(e),t}getObjectColor(e){return this.regs[U]&16&&e>=4?this.regs[he]:this.regs[y+(e&3)]}evalTrigger(e){this.regs[se+e]+this.hbias==this.count&&this.triggerObject(e)}triggerObject(e){let t,s;if(this.pmDebugMask&1<<e){if(e<4)t=this.regs[ie+e]&3,s=this.regs[bt+e];else{let n=e-4<<1;t=this.regs[re]>>n&3,s=(this.regs[_t]>>n&3)<<6}t&1?s=Et(s):s<<=8,t==3?s=Et(s):s<<=16,this.shiftregs[e]|=s}}clockPulse1(){this.processPlayerMissile(),this.clockPulse2(),this.count++}clockPulse2(){var e;if(this.pmcol>=0)e=this.pmcol;else{let t=this.getPlayfieldColor();e=t&256?t&255:this.regs[t]}this.rgb=Ot[e],this.gtiacol2=this.gtiacol2<<1|this.an>>3}clockPulse4(){this.gtiacol=this.gtiacol2&15}static stateToLongString(e){let t="";return t+=`X: ${C(e.count,3)}  ANTIC: ${f(e.an,1)}  PM: ${f(e.pmcol,3)}
`,t+=`Write Registers:
`,t+=E(e.regs,0,32),t+=`Read Registers:
`,t+=E(e.readregs,0,32),t}};function Et(r){return r=(r|r<<8)&16711935,r=(r|r<<4)&252645135,r=(r|r<<2)&858993459,r=(r|r<<1)&1431655765,r|r<<1}var Ot=new Uint32Array(256);for(L=0;L<256;L++)Ot[L]=ht(L);var L;var c=0;var ge=2;var Rt=4;var It=6;var p=8,me=9,pe=10,be=11,_e=13,J=14,I=15;var ye=8,Ae=9,Ee=10,Se=13,D=14,H=15;var Tt=128,Dt=64,Oe=32,Pt=16,vt=8;var Re=1,Ct=28,Ie=114;var Mt=511,kt=131071,u=0,g=1,b=2,d=3,R=114,Te=15;var De=8;var tt,Q;function Pe(){tt=new Uint8Array(511),Q=new Uint8Array(16385);let r=511;for(let e=0;e<511;e++)r=(((r>>5^r)&1)<<8)+(r>>1),tt[e]=r;r=131071;for(let e=0;e<16385;e++)r=(((r>>5^r)&255)<<9)+(r>>8),Q[e]=r>>1}var V=class{constructor(e,t){this.irq=e;this.antic_xpos=t;this.regs=new Uint8Array(16);this.readregs=new Uint8Array(16);this.divnirq=new Uint32Array(4);this.divnmax=new Uint32Array(4);this.pot_inputs=new Uint8Array(8);this.basemult=0;this.pot_scanline=0;this.random_scanline_counter=0;this.kbcode=0;this.DELAYED_SERIN_IRQ=0;this.DELAYED_SEROUT_IRQ=0;this.DELAYED_XMTDONE_IRQ=0;this.init()}saveState(){return _(0,{},this)}loadState(e){_(0,this,e)}init(){this.readregs.fill(255),this.readregs[H]=239,this.basemult=Ct,this.pot_inputs.fill(128),Pe()}read(e){let t=this.readregs[e];switch(e&=15,e){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:return t=this.pot_inputs[e],t<this.pot_scanline?t:this.pot_scanline;case ye:for(let s=0;s<8;s++)this.pot_inputs[s]<=this.pot_scanline&&(t&=~(1<<s));break;case Ae:return this.kbcode;case H:t=H+(this.CASSETTE_IOLineStatus()<<4);break;case Ee:if((this.regs[I]&3)!=0){let s=this.random_scanline_counter+this.antic_xpos();if(this.regs[p]&Tt)t=tt[s%Mt];else{s%=kt;let n=s>>3;s&=7,t=(Q[n]>>s)+(Q[n+1]<<8-s)}}break}return t&255}write(e,t){switch(e&=15,this.regs[e]=t,e){case p:t&Re?this.basemult=Ie:this.basemult=Ct,this.update_counter(1<<u|1<<g|1<<b|1<<d);break;case c:this.update_counter(this.regs[p]&Pt?1<<g|1<<u:1<<u);break;case ge:this.update_counter(1<<g);break;case Rt:this.update_counter(this.regs[p]&vt?1<<d|1<<b:1<<b);break;case It:this.update_counter(1<<d);break;case J:this.readregs[D]|=~t&247,~this.readregs[D]&this.regs[J]&&this.generateIRQ(this.readregs[D]);break;case pe:this.readregs[H]|=224;break;case be:this.regs[I]&4||(this.pot_scanline=0);break;case _e:(this.regs[I]&112)==32&&this.siocheck()&&this.SIO_PutByte(t),(this.regs[I]&8)==0?(this.DELAYED_SEROUT_IRQ=De,this.readregs[D]|=8,this.DELAYED_XMTDONE_IRQ=Te):(this.DELAYED_SEROUT_IRQ=312*50*10*(this.regs[Rt]+this.regs[It]*256)/895e3,this.DELAYED_SEROUT_IRQ>=3?(this.readregs[D]|=8,this.DELAYED_XMTDONE_IRQ=2*this.DELAYED_SEROUT_IRQ-2):(this.DELAYED_SEROUT_IRQ=0,this.DELAYED_XMTDONE_IRQ=0));break;case me:this.divnirq[u]=this.divnmax[u],this.divnirq[g]=this.divnmax[g],this.divnirq[b]=this.divnmax[b],this.divnirq[d]=this.divnmax[d];break;case I:t&4&&(this.pot_scanline=228),(t&3)==0&&(this.DELAYED_SERIN_IRQ=0,this.DELAYED_SEROUT_IRQ=0,this.DELAYED_XMTDONE_IRQ=0);break}this.snd_update(e)}update_counter(e){e&1<<u&&(this.regs[p]&Dt?this.divnmax[u]=this.regs[c+u]+4:this.divnmax[u]=(this.regs[c+u]+1)*this.basemult,this.divnmax[u]<R&&(this.divnmax[u]=R)),e&1<<g&&(this.regs[p]&Pt?this.regs[p]&Dt?this.divnmax[g]=this.regs[c+g]*256+this.regs[c+u]+7:this.divnmax[g]=(this.regs[c+g]*256+this.regs[c+u]+1)*this.basemult:this.divnmax[g]=(this.regs[c+g]+1)*this.basemult,this.divnmax[g]<R&&(this.divnmax[g]=R)),e&1<<d&&(this.regs[p]&vt?this.regs[p]&Oe?this.divnmax[d]=this.regs[c+d]*256+this.regs[c+b]+7:this.divnmax[d]=(this.regs[c+d]*256+this.regs[c+b]+1)*this.basemult:this.divnmax[d]=(this.regs[c+d]+1)*this.basemult,this.divnmax[d]<R&&(this.divnmax[d]=R))}snd_update(e){}advanceScanline(){(this.regs[I]&3)!=0&&(this.pot_scanline<228&&this.pot_scanline++,this.random_scanline_counter+=R,this.random_scanline_counter%=this.regs[p]&Tt?Mt:kt,this.DELAYED_SERIN_IRQ>0&&--this.DELAYED_SERIN_IRQ==0&&(this.readregs[Se]=this.SIO_GetByte(),this.generateIRQ(32)),this.DELAYED_SEROUT_IRQ>0&&--this.DELAYED_SEROUT_IRQ==0&&this.generateIRQ(16),this.DELAYED_XMTDONE_IRQ>0&&--this.DELAYED_XMTDONE_IRQ==0&&this.generateIRQ(8),this.advanceIRQTimer(u,1),this.advanceIRQTimer(g,2),this.advanceIRQTimer(d,4))}advanceIRQTimer(e,t){(this.divnirq[e]-=R)<0&&(this.divnirq[e]+=this.divnmax[e],this.generateIRQ(t))}generateIRQ(e){this.regs[J]&e&&(this.irq(),this.readregs[D]&=~e)}static stateToLongString(e){let t="";return t+=`Write Registers:
`,t+=E(e.regs,0,16),t+=`Read Registers:
`,t+=E(e.readregs,0,16),t}CASSETTE_IOLineStatus(){return 0}siocheck(){return((this.regs[c+b]==40||this.regs[c+b]==16||this.regs[c+b]==8||this.regs[c+b]==10)&&this.regs[c+d]==0||(this.regs[I]&120)==40)&&(this.regs[p]&40)==40}SIO_PutByte(e){console.log("SIO put byte",e)}SIO_GetByte(){return 0}};var ve=[i.VK_L,i.VK_J,i.VK_SEMICOLON,i.VK_F4,i.VK_F5,i.VK_K,i.VK_BACK_SLASH,i.VK_TILDE,i.VK_O,null,i.VK_P,i.VK_U,i.VK_ENTER,i.VK_I,i.VK_MINUS2,i.VK_EQUALS2,i.VK_V,i.VK_F7,i.VK_C,i.VK_F6,i.VK_F4,i.VK_B,i.VK_X,i.VK_Z,i.VK_4,null,i.VK_3,i.VK_6,i.VK_ESCAPE,i.VK_5,i.VK_2,i.VK_1,i.VK_COMMA,i.VK_SPACE,i.VK_PERIOD,i.VK_N,null,i.VK_M,i.VK_SLASH,null,i.VK_R,null,i.VK_E,i.VK_Y,i.VK_TAB,i.VK_T,i.VK_W,i.VK_Q,i.VK_9,null,i.VK_0,i.VK_7,i.VK_BACK_SPACE,i.VK_8,null,null,i.VK_F,i.VK_H,i.VK_D,null,i.VK_CAPS_LOCK,i.VK_G,i.VK_S,i.VK_A],Ce=nt([[i.UP,0,1],[i.DOWN,0,2],[i.LEFT,0,4],[i.RIGHT,0,8],[{c:16,n:"Shift",plyr:0,button:0},2,1],[i.VK_F1,3,1],[i.VK_F2,3,2],[i.VK_F3,3,4]]),w=class extends lt{constructor(){super();this.cpuFrequency=1789773;this.numTotalScanlines=262;this.cpuCyclesPerLine=114;this.canvasWidth=336;this.numVisibleScanlines=224;this.aspectRatio=this.canvasWidth/this.numVisibleScanlines*.857;this.firstVisibleScanline=16;this.firstVisibleClock=76;this.defaultROMSize=32768;this.overscan=!0;this.audioOversample=2;this.sampleRate=this.numTotalScanlines*60*this.audioOversample;this.run_address=-1;this.inputs=new Uint8Array(4);this.linergb=new Uint32Array(this.canvasWidth);this.lastdmabyte=0;this.keycode=0;this.cart_80=!1;this.cart_a0=!1;this.xexdata=null;this.keyboard_active=!0;this.d500=new Uint8Array(256);this.cpu=new ft,this.ram=new Uint8Array(65536),this.bios=new Uint8Array(10240),this.bus=this.newBus(),this.connectCPUMemoryBus(this.bus),this.antic=new k(this.readDMA.bind(this),this.antic_nmi.bind(this)),this.gtia=new K,this.irq_pokey=new V(this.pokey_irq.bind(this),()=>this.antic.h),this.audio_pokey=ot(1),this.audioadapter=new ct(this.audio_pokey.pokey1,this.audioOversample,this.sampleRate),this.handler=at(this.inputs,Ce,this.getKeyboardFunction(),!0)}newBus(){return{read:M([[0,32767,65535,t=>this.ram[t]],[32768,40959,65535,t=>this.cart_80?this.rom[t-32768]:this.ram[t]],[40960,49151,65535,t=>this.cart_a0?this.rom[t-32768]:this.ram[t]],[53248,53503,31,t=>this.gtia.readReg(t)],[53760,54015,15,t=>this.readPokey(t)],[54016,54271,15,t=>this.readPIA(t)],[54272,54527,15,t=>this.antic.readReg(t)],[54528,54783,255,t=>this.d500[t]],[55296,65535,65535,t=>this.bios[t-55296]]]),write:M([[0,49146,65535,(t,s)=>{this.ram[t]=s}],[49147,49151,65535,(t,s)=>{this.ram[t]=s,this.initCartA()}],[53248,53503,31,(t,s)=>{this.gtia.setReg(t,s)}],[53760,54015,15,(t,s)=>{this.writePokey(t,s)}],[54272,54527,15,(t,s)=>{this.antic.setReg(t,s)}],[54528,54783,255,(t,s)=>{this.writeMapper(t,s)}]])}}loadBIOS(t){this.bios.set(t)}reset(){super.reset(),this.antic.reset(),this.gtia.reset(),this.keycode=0}read(t){return this.bus.read(t)}readDMA(t){let s=this.bus.read(t);return this.probe.logDMARead(t,s),this.lastdmabyte=s,s}readConst(t){return t<53248||t>=54528?this.bus.read(t):255}write(t,s){this.bus.write(t,s)}readPokey(t){switch(t&15){case 9:return this.keycode&255;case 15:return~this.keycode>>6&4|~this.keycode>>3&8|18;default:return this.irq_pokey.read(t)}}readPIA(t){if(t==0||t==1)return~this.inputs[t]}writePokey(t,s){this.audio_pokey.pokey1.setRegister(t,s),this.irq_pokey.write(t,s)}startScanline(){this.gtia.sync();for(let t=0;t<4;t++)this.gtia.readregs[St+t]=~this.inputs[2]>>t&1;this.gtia.readregs[$]=~this.inputs[3]&7,this.audio&&this.audioadapter.generate(this.audio),this.irq_pokey.advanceScanline()}drawScanline(){let t=this.antic.v-this.firstVisibleScanline;t>=0&&t<this.numVisibleScanlines&&this.pixels.set(this.linergb,t*this.canvasWidth)}advanceCPU(){this.antic.clockPulse()?(this.antic.h<8&&this.gtia.updateGfx(this.antic.h-1,this.antic.v,this.lastdmabyte),this.antic.isWSYNC()&&this.probe.logWait(0),this.probe.logClocks(1)):super.advanceCPU();let t=this.antic.h*4-this.firstVisibleClock,s=()=>{this.gtia.clockPulse1(),this.linergb[t++]=this.gtia.rgb},n=()=>{this.gtia.clockPulse2(),this.linergb[t++]=this.gtia.rgb};this.gtia.clockPulse4(),this.antic.dliop&16&&this.antic.regs[4]&1?(t+=2,this.gtia.setBias(-1)):this.gtia.setBias(0);let a=pt[this.antic.mode],h=this.antic.h&1;return(a<8||h)&&(this.gtia.an=this.antic.shiftout()),s(),a==1&&(this.gtia.an=this.antic.shiftout()),n(),a<=2&&(this.gtia.an=this.antic.shiftout()),s(),a==1&&(this.gtia.an=this.antic.shiftout()),n(),1}loadState(t){this.loadControlsState(t),this.cpu.loadState(t.c),this.ram.set(t.ram),this.antic.loadState(t.antic),this.gtia.loadState(t.gtia),this.irq_pokey.loadState(t.pokey),this.lastdmabyte=t.lastdmabyte,this.cart_80=t.cart_80,this.cart_a0=t.cart_a0}saveState(){return{c:this.cpu.saveState(),ram:this.ram.slice(0),antic:this.antic.saveState(),gtia:this.gtia.saveState(),pokey:this.irq_pokey.saveState(),inputs:this.inputs.slice(0),lastdmabyte:this.lastdmabyte,keycode:this.keycode,cart_80:this.cart_80,cart_a0:this.cart_a0}}loadControlsState(t){this.inputs.set(t.inputs),this.keycode=t.keycode}saveControlsState(){return{inputs:this.inputs.slice(0),keycode:this.keycode}}getRasterY(){return this.antic.v}getRasterX(){return this.antic.h}getRasterCanvasPosition(){return{x:this.antic.h*4-this.firstVisibleClock,y:this.antic.v-this.firstVisibleScanline}}getDebugCategories(){return["CPU","Stack","ANTIC","GTIA","POKEY"]}getDebugInfo(t,s){switch(t){case"ANTIC":return k.stateToLongString(s.antic);case"GTIA":return K.stateToLongString(s.gtia);case"POKEY":return V.stateToLongString(s.pokey)}}getKeyboardFunction(){return(t,s,n,a)=>{if(!this.keyboard_active)return!1;if(a&65){var h=ve;if(s==i.VK_F9.c)return this.irq_pokey.generateIRQ(128),!0;for(var l=0;l<h.length;l++)if(h[l]&&h[l].c==s&&(this.keycode=l,a&2&&(this.keycode|=64),a&4&&(this.keycode|=128),a&1))return this.keycode|=256,this.irq_pokey.generateIRQ(64),!0}}}pokey_irq(){this.cpu.IRQ(),this.probe.logInterrupt(2)}antic_nmi(){this.cpu.NMI(),this.probe.logInterrupt(1)}loadROM(t,s){t[0]==255&&t[1]==255&&!(s!=null&&s.endsWith(".rom"))?this.xexdata=t:this.loadCartridge(t)}loadCartridge(t){if(t[0]==67&&t[1]==65&&t[2]==82&&t[3]==84&&(t=t.slice(16)),t.length!=4096&&t.length!=8192&&t.length!=16384&&t.length!=32768)throw new Error("Sorry, this platform can only load 4/8/16/32 KB cartridges at the moment.");let s=new Uint8Array(32768);for(let n=0;n<=s.length-t.length;n+=t.length)s.set(t,n);this.run_address=s[32766]+s[32767]*256,this.cart_a0=!0,this.cart_80=t.length==16384,super.loadROM(s)}writeMapper(t,s){t==255&&(s==128&&(this.cart_80=!1),s==160&&(this.cart_a0=!1))}loadXEX(t){let s=2,n=this.d500,a=0;for(var h=-1;s<t.length;){let o=t[s+0]+t[s+1]*256,A=t[s+2]+t[s+3]*256;console.log("XEX",f(s),f(o),f(A)),s+=4;for(let x=o;x<=A;x++)this.ram[x]=t[s++];if(o==736&&A==737&&(h=this.ram[736]+this.ram[737]*256,console.log("XEX run",f(h))),o==738&&A==739){var l=this.ram[738]+this.ram[739]*256;console.log("XEX init",f(l)),n[a++]=32,n[a++]=l&255,n[a++]=l>>8}if(s>t.length)throw new Error("Bad .XEX file format")}h>=0&&(n[a++]=169,n[a++]=160,n[a++]=141,n[a++]=255,n[a++]=213,n[a++]=76,n[a++]=h&255,n[a++]=h>>8,this.ram[10]=0,this.ram[11]=213,this.run_address=54528)}initCartA(){this.cpu.getPC()==61823&&this.xexdata&&this.loadXEX(this.xexdata)}setPaddleInput(t,s){this.irq_pokey.pot_inputs[t]=255-s}getDebugDisplayList(){let t=this.antic.getDlistAddr(),s=()=>{let h=this.read(t);return t=t+1&1023|t&-1024,h},n=[],a=0;for(let h=0;h<256&&a<240;h++){let l=t,o=s(),A=o&15,x="",P=!1,v;if(A==0)v=(o>>4&7)+1,x+=" blank="+v;else{v=Z[A],x+=" mode="+f(A),x+=" lines="+v,P=(o&-65)==1;let rt=(o&64)!=0&&(o&15)!=0;if(o&16&&(x+=" HSCROL"),o&32&&(x+=" VSCROL"),o&128&&(x+=" DLI"),P&&o&64?x+=" JVB":P?x+=" JMP":rt&&(x+=" LMS"),P||rt){let Nt=s(),Ft=s();x+=" $"+f(Ft)+f(Nt)}}if(n.push("$"+f(l)+" y="+a+" "+x),P)break;a+=v}return n}},j=class extends w{newBus(){return{read:M([[0,16383,65535,e=>this.ram[e]],[16384,49151,65535,e=>this.rom?this.rom[e-16384]:0],[49152,53247,31,e=>this.gtia.readReg(e)],[54272,54527,15,e=>this.antic.readReg(e)],[59392,61439,15,e=>this.readPokey(e)],[63488,65535,2047,e=>this.bios[e]]]),write:M([[0,16383,65535,(e,t)=>{this.ram[e]=t}],[49152,53247,31,(e,t)=>{this.gtia.setReg(e,t)}],[54272,54527,15,(e,t)=>{this.antic.setReg(e,t)}],[59392,61439,15,(e,t)=>{this.writePokey(e,t)}]])}}};var it=[{id:"hello.dasm",name:"Hello World (ASM)"},{id:"hellopm.dasm",name:"Hello Sprites (ASM)"},{id:"helloconio.c",name:"Text Mode (C)"},{id:"siegegame.c",name:"Siege Game (C)"},{id:"hellodlist.c",name:"Display List (C)"}],Lt=it.concat([{id:"testmusic.c",name:"POKEY Music (C)"},{id:"sieve.bas",name:"Benchmark (FastBasic)",category:"FastBasic"},{id:"pmtest.bas",name:"Sprites Test (FastBasic)"},{id:"dli.bas",name:"DLI Test (FastBasic)"},{id:"joyas.bas",name:"Match-3 Game (FastBasic)"}]),Kt={main:[{name:"RAM",start:0,size:49152,type:"ram"},{name:"Left Cartridge ROM",start:40960,size:8192,type:"rom"},{name:"GTIA",start:53248,size:32,type:"io"},{name:"POKEY",start:53760,size:16,type:"io"},{name:"PIA",start:54016,size:4,type:"io"},{name:"ANTIC",start:54272,size:16,type:"io"},{name:"Cartridge Control Line",start:54784,size:256,type:"io"},{name:"ROM",start:55296,size:2048,type:"rom"},{name:"Character Set",start:57344,size:1024,type:"rom"},{name:"ROM",start:58368,size:7168,type:"rom"}]};function Vt(r){return r.endsWith(".bas")||r.endsWith(".fb")||r.endsWith(".fbi")?"fastbasic":dt(r)}var z=class extends ut{constructor(){super(...arguments);this.getToolForFilename=Vt;this.showHelp=wt;this.getROMExtension=Me;this.biosPath="res/altirra/kernel.rom"}newMachine(){return new w}getPresets(){return Lt}getDefaultExtension(){return".c"}readAddress(t){return this.machine.readConst(t)}getMemoryMap(){return Kt}async start(){let t=await this.loadKernel();await super.start(),this.machine.loadBIOS(t)}async loadKernel(){var t=await fetch(this.biosPath);if(t.status==200||t.size){var s=await t.arrayBuffer();return new Uint8Array(s)}else throw new Error("could not load BIOS file")}getDebugTree(){let t=super.getDebugTree();return t.display_list=this.machine.getDebugDisplayList(),t}},et=class extends z{constructor(){super(...arguments);this.biosPath="res/altirra/superkernel.rom"}getPresets(){return it}newMachine(){return new j}},X=class extends gt{constructor(){super(...arguments);this.getToolForFilename=Vt;this.getOpcodeMetadata=xt;this.showHelp=wt}getPresets(){return it}getDefaultExtension(){return".asm"}},q=class extends X{constructor(){super(...arguments);this.getMemoryMap=function(){return Kt}}getPresets(){return Lt}loadROM(t,s){this.started?(this.loadROMFile(s),this.loadRegion(":cartleft:cart:rom",s)):this.startModule(this.mainElement,{jsfile:"mame8bitws.js",biosfile:"a800xl.zip",cfgfile:"a800xl.cfg",driver:"a800xl",width:336*2,height:450,romfn:"/emulator/cart.rom",romdata:new Uint8Array(s),romsize:8192,preInit:function(n){}})}start(){}},st=class extends X{constructor(){super(...arguments);this.getMemoryMap=function(){return{main:[{name:"RAM",start:0,size:16384,type:"ram"},{name:"Cartridge ROM",start:16384,size:32768,type:"rom"},{name:"GTIA",start:49152,size:32,type:"io"},{name:"ANTIC",start:54272,size:16,type:"io"},{name:"POKEY",start:59392,size:16,type:"io"},{name:"ATARI Character Set",start:63488,size:1024,type:"rom"},{name:"ROM",start:64512,size:1024,type:"rom"}]}}}loadROM(t,s){this.started?(this.loadROMFile(s),this.loadRegion(":cartleft:cart:rom",s)):this.startModule(this.mainElement,{jsfile:"mame8bitws.js",biosfile:"a5200/5200.rom",cfgfile:"a5200.cfg",driver:"a5200",width:336*2,height:450,romfn:"/emulator/cart.rom",romdata:new Uint8Array(s),romsize:32768,preInit:function(n){}})}start(){}};function Me(r){return r==null?".bin":r[0]==255&&r[1]==255?".xex":".rom"}function wt(){return"https://8bitworkshop.com/docs/platforms/atari8/"}T["atari8-800.xlmame"]=q;T["atari8-800xl.mame"]=q;T["atari8-5200.mame"]=st;T["atari8-800"]=z;T["atari8-5200"]=et;
//# sourceMappingURL=atari8-3N6RTOI3.js.map
